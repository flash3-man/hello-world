# 项目部署指南

## 🚀 部署架构概览

### 环境规划
```
开发环境 (Development)
├── 本地开发环境 (Local)
├── 开发服务器 (Dev Server)
└── 功能测试环境 (Feature Test)

测试环境 (Testing)
├── 集成测试环境 (Integration Test)
├── 性能测试环境 (Performance Test)
└── 用户验收测试环境 (UAT)

生产环境 (Production)
├── 预生产环境 (Pre-Production)
└── 生产环境 (Production)
```

### 基础设施架构
```
┌─────────────────────────────────────────────────────────────┐
│                        负载均衡层                            │
│  Nginx + Keepalived (高可用)                               │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        应用层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ API Gateway │  │ Web应用     │  │ 移动端API   │        │
│  │ (多实例)    │  │ (多实例)    │  │ (多实例)    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        服务层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 用户服务    │  │ 数据服务    │  │ 分析服务    │        │
│  │ (集群)      │  │ (集群)      │  │ (集群)      │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        数据层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ MySQL主从   │  │ Redis集群   │  │ RabbitMQ    │        │
│  │ (读写分离)  │  │ (哨兵模式)  │  │ (集群模式)  │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## 🐳 Docker容器化部署

### Dockerfile规范
```dockerfile
# 后端服务Dockerfile
FROM openjdk:11-jre-slim

# 设置工作目录
WORKDIR /app

# 创建应用用户
RUN groupadd -r appuser && useradd -r -g appuser appuser

# 复制应用文件
COPY target/business-analysis-*.jar app.jar

# 设置文件权限
RUN chown -R appuser:appuser /app

# 切换到应用用户
USER appuser

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# 暴露端口
EXPOSE 8080

# JVM参数优化
ENV JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/app/logs/"

# 启动命令
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -jar app.jar"]
```

```dockerfile
# 前端应用Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

# 复制package文件
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制源码
COPY . .

# 构建应用
RUN npm run build

# 生产镜像
FROM nginx:alpine

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 复制nginx配置
COPY nginx.conf /etc/nginx/nginx.conf

# 暴露端口
EXPOSE 80

# 启动nginx
CMD ["nginx", "-g", "daemon off;"]
```

### Docker Compose配置
```yaml
# docker-compose.yml
version: '3.8'

services:
  # MySQL数据库
  mysql:
    image: mysql:8.0
    container_name: business-analysis-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: business_analysis
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    command: --default-authentication-plugin=mysql_native_password
    restart: unless-stopped
    networks:
      - business-network
    
  # Redis缓存
  redis:
    image: redis:6.0-alpine
    container_name: business-analysis-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: unless-stopped
    networks:
      - business-network
    
  # RabbitMQ消息队列
  rabbitmq:
    image: rabbitmq:3.8-management
    container_name: business-analysis-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    restart: unless-stopped
    networks:
      - business-network
    
  # API网关
  gateway:
    build:
      context: ./business-analysis-gateway
      dockerfile: Dockerfile
    container_name: business-analysis-gateway
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka:8761/eureka
    ports:
      - "8080:8080"
    depends_on:
      - eureka
      - redis
    restart: unless-stopped
    networks:
      - business-network
    
  # 用户服务
  user-service:
    build:
      context: ./business-analysis-modules/user-service
      dockerfile: Dockerfile
    container_name: business-analysis-user-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=business_analysis
      - DB_USERNAME=${MYSQL_USER}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - mysql
      - redis
      - eureka
    restart: unless-stopped
    networks:
      - business-network
    
  # 数据服务
  data-service:
    build:
      context: ./business-analysis-modules/data-service
      dockerfile: Dockerfile
    container_name: business-analysis-data-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DB_HOST=mysql
      - REDIS_HOST=redis
      - RABBITMQ_HOST=rabbitmq
    depends_on:
      - mysql
      - redis
      - rabbitmq
      - eureka
    restart: unless-stopped
    networks:
      - business-network
    
  # 前端应用
  web-app:
    build:
      context: ./business-analysis-web
      dockerfile: Dockerfile
    container_name: business-analysis-web
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - gateway
    restart: unless-stopped
    networks:
      - business-network

# 网络配置
networks:
  business-network:
    driver: bridge

# 数据卷配置
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
```

### 环境变量配置
```bash
# .env
# 数据库配置
MYSQL_ROOT_PASSWORD=root123456
MYSQL_USER=business_user
MYSQL_PASSWORD=business_password

# Redis配置
REDIS_PASSWORD=redis123456

# RabbitMQ配置
RABBITMQ_USER=admin
RABBITMQ_PASSWORD=admin123456

# 应用配置
SPRING_PROFILES_ACTIVE=docker
JWT_SECRET=business-analysis-jwt-secret-key-2024
API_BASE_URL=https://api.business-analysis.com

# 监控配置
PROMETHEUS_ENABLED=true
GRAFANA_ADMIN_PASSWORD=grafana123456

# 日志配置
LOG_LEVEL=INFO
LOG_PATH=/app/logs
```

## ☸️ Kubernetes部署

### 命名空间配置
```yaml
# namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: business-analysis
  labels:
    name: business-analysis
    environment: production
```

### ConfigMap配置
```yaml
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: business-analysis-config
  namespace: business-analysis
data:
  application.yml: |
    spring:
      datasource:
        url: jdbc:mysql://mysql-service:3306/business_analysis
        username: ${DB_USERNAME}
        password: ${DB_PASSWORD}
      redis:
        host: redis-service
        port: 6379
        password: ${REDIS_PASSWORD}
      rabbitmq:
        host: rabbitmq-service
        port: 5672
        username: ${RABBITMQ_USERNAME}
        password: ${RABBITMQ_PASSWORD}
    
    logging:
      level:
        root: INFO
        com.company.businessanalysis: INFO
      file:
        name: /app/logs/application.log
    
    management:
      endpoints:
        web:
          exposure:
            include: health,info,metrics,prometheus
```

### Secret配置
```yaml
# secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: business-analysis-secret
  namespace: business-analysis
type: Opaque
data:
  # Base64编码的敏感信息
  db-username: YnVzaW5lc3NfdXNlcg==  # business_user
  db-password: YnVzaW5lc3NfcGFzc3dvcmQ=  # business_password
  redis-password: cmVkaXMxMjM0NTY=  # redis123456
  rabbitmq-username: YWRtaW4=  # admin
  rabbitmq-password: YWRtaW4xMjM0NTY=  # admin123456
  jwt-secret: YnVzaW5lc3MtYW5hbHlzaXMtand0LXNlY3JldC1rZXktMjAyNA==
```

### Deployment配置
```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: business-analysis-api
  namespace: business-analysis
  labels:
    app: business-analysis-api
    version: v1.0.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: business-analysis-api
  template:
    metadata:
      labels:
        app: business-analysis-api
        version: v1.0.0
    spec:
      containers:
      - name: api
        image: business-analysis/api:1.0.0
        ports:
        - containerPort: 8080
          name: http
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "k8s"
        - name: DB_USERNAME
          valueFrom:
            secretKeyRef:
              name: business-analysis-secret
              key: db-username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: business-analysis-secret
              key: db-password
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: business-analysis-secret
              key: redis-password
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: business-analysis-secret
              key: jwt-secret
        
        # 资源限制
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        
        # 健康检查
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
        
        # 存储卷挂载
        volumeMounts:
        - name: config-volume
          mountPath: /app/config
        - name: logs-volume
          mountPath: /app/logs
        
      volumes:
      - name: config-volume
        configMap:
          name: business-analysis-config
      - name: logs-volume
        emptyDir: {}
      
      # 镜像拉取策略
      imagePullPolicy: IfNotPresent
      
      # 重启策略
      restartPolicy: Always
```

### Service配置
```yaml
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: business-analysis-api-service
  namespace: business-analysis
  labels:
    app: business-analysis-api
spec:
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: business-analysis-api

---
# 负载均衡服务
apiVersion: v1
kind: Service
metadata:
  name: business-analysis-api-lb
  namespace: business-analysis
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: nlb
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
  selector:
    app: business-analysis-api
```

### Ingress配置
```yaml
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: business-analysis-ingress
  namespace: business-analysis
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/rate-limit: "100"
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - api.business-analysis.com
    - app.business-analysis.com
    secretName: business-analysis-tls
  rules:
  - host: api.business-analysis.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: business-analysis-api-service
            port:
              number: 8080
  - host: app.business-analysis.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: business-analysis-web-service
            port:
              number: 80
```

## 📊 监控与日志

### Prometheus监控配置
```yaml
# prometheus-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: business-analysis
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    
    rule_files:
      - "/etc/prometheus/rules/*.yml"
    
    scrape_configs:
      # 应用监控
      - job_name: 'business-analysis-api'
        static_configs:
          - targets: ['business-analysis-api-service:8080']
        metrics_path: '/actuator/prometheus'
        scrape_interval: 30s
      
      # 数据库监控
      - job_name: 'mysql'
        static_configs:
          - targets: ['mysql-exporter:9104']
      
      # Redis监控
      - job_name: 'redis'
        static_configs:
          - targets: ['redis-exporter:9121']
      
      # Kubernetes监控
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
    
    alerting:
      alertmanagers:
        - static_configs:
            - targets: ['alertmanager:9093']
```

### 告警规则配置
```yaml
# alert-rules.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
  namespace: business-analysis
data:
  business-analysis.yml: |
    groups:
    - name: business-analysis-alerts
      rules:
      # 应用可用性告警
      - alert: ApplicationDown
        expr: up{job="business-analysis-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "应用服务不可用"
          description: "{{ $labels.instance }} 应用服务已停止响应超过1分钟"
      
      # 高错误率告警
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "应用错误率过高"
          description: "{{ $labels.instance }} 5xx错误率超过10%"
      
      # 响应时间告警
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "应用响应时间过长"
          description: "{{ $labels.instance }} 95%请求响应时间超过1秒"
      
      # 内存使用率告警
      - alert: HighMemoryUsage
        expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "内存使用率过高"
          description: "{{ $labels.instance }} 内存使用率超过80%"
      
      # CPU使用率告警
      - alert: HighCPUUsage
        expr: (rate(container_cpu_usage_seconds_total[5m]) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPU使用率过高"
          description: "{{ $labels.instance }} CPU使用率超过80%"
      
      # 数据同步失败告警
      - alert: DataSyncFailure
        expr: increase(data_sync_failures_total[1h]) > 0
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "数据同步任务失败"
          description: "数据同步任务在过去1小时内失败了 {{ $value }} 次"
      
      # 数据库连接告警
      - alert: DatabaseConnectionFailure
        expr: mysql_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "数据库连接失败"
          description: "无法连接到MySQL数据库"
```

### Grafana仪表板配置
```json
{
  "dashboard": {
    "id": null,
    "title": "经营分析APP监控仪表板",
    "tags": ["business-analysis"],
    "timezone": "browser",
    "panels": [
      {
        "id": 1,
        "title": "应用状态概览",
        "type": "stat",
        "targets": [
          {
            "expr": "up{job=\"business-analysis-api\"}",
            "legendFormat": "服务状态"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {
              "mode": "thresholds"
            },
            "thresholds": {
              "steps": [
                {"color": "red", "value": 0},
                {"color": "green", "value": 1}
              ]
            }
          }
        }
      },
      {
        "id": 2,
        "title": "请求QPS",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "QPS"
          }
        ]
      },
      {
        "id": 3,
        "title": "响应时间分布",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "P50"
          },
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "P95"
          },
          {
            "expr": "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "P99"
          }
        ]
      }
    ],
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "refresh": "30s"
  }
}
```
