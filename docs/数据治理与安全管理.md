# æ•°æ®æ²»ç†ä¸å®‰å…¨ç®¡ç†

## ğŸ›¡ï¸ æ•°æ®æ²»ç†æ¡†æ¶

### æ•´ä½“æ²»ç†æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®æ²»ç†å§”å‘˜ä¼š                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ æ•°æ®è´Ÿè´£äºº  â”‚  â”‚ ä¸šåŠ¡è´Ÿè´£äºº  â”‚  â”‚ æŠ€æœ¯è´Ÿè´£äºº  â”‚        â”‚
â”‚  â”‚ CDO         â”‚  â”‚ Business    â”‚  â”‚ CTO         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ²»ç†æ‰§è¡Œå±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ æ•°æ®ç®¡ç†    â”‚  â”‚ è´¨é‡ç®¡ç†    â”‚  â”‚ å®‰å…¨ç®¡ç†    â”‚        â”‚
â”‚  â”‚ Data Mgmt   â”‚  â”‚ Quality     â”‚  â”‚ Security    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ å…ƒæ•°æ®ç®¡ç†  â”‚  â”‚ ç”Ÿå‘½å‘¨æœŸ    â”‚  â”‚ åˆè§„ç®¡ç†    â”‚        â”‚
â”‚  â”‚ Metadata    â”‚  â”‚ Lifecycle   â”‚  â”‚ Compliance  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æŠ€æœ¯æ”¯æ’‘å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ æ•°æ®ç›®å½•    â”‚  â”‚ è¡€ç¼˜è¿½è¸ª    â”‚  â”‚ è´¨é‡ç›‘æ§    â”‚        â”‚
â”‚  â”‚ Catalog     â”‚  â”‚ Lineage     â”‚  â”‚ Monitor     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ æƒé™æ§åˆ¶    â”‚  â”‚ å®¡è®¡æ—¥å¿—    â”‚  â”‚ åŠ å¯†å­˜å‚¨    â”‚        â”‚
â”‚  â”‚ Access      â”‚  â”‚ Audit       â”‚  â”‚ Encryption  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æ²»ç†ç­–ç•¥

#### 1. æ•°æ®åˆ†ç±»åˆ†çº§
```yaml
# æ•°æ®åˆ†ç±»æ ‡å‡†
data_classification:
  levels:
    - name: "å…¬å¼€æ•°æ®"
      level: 1
      description: "å¯ä»¥å…¬å¼€å‘å¸ƒçš„æ•°æ®"
      examples: ["äº§å“ç›®å½•", "å…¬å¸ä»‹ç»", "è¡Œä¸šæŠ¥å‘Š"]
      protection_requirements:
        - "åŸºç¡€è®¿é—®æ§åˆ¶"
        - "æ ‡å‡†å¤‡ä»½"
      
    - name: "å†…éƒ¨æ•°æ®"
      level: 2
      description: "ä»…é™å†…éƒ¨ä½¿ç”¨çš„æ•°æ®"
      examples: ["å‘˜å·¥ä¿¡æ¯", "å†…éƒ¨æŠ¥è¡¨", "ä¼šè®®è®°å½•"]
      protection_requirements:
        - "èº«ä»½è®¤è¯"
        - "è®¿é—®æ—¥å¿—"
        - "å®šæœŸå¤‡ä»½"
      
    - name: "æœºå¯†æ•°æ®"
      level: 3
      description: "æ¶‰åŠå•†ä¸šæœºå¯†çš„æ•æ„Ÿæ•°æ®"
      examples: ["è´¢åŠ¡æ•°æ®", "å®¢æˆ·ä¿¡æ¯", "é”€å”®æ•°æ®"]
      protection_requirements:
        - "å¼ºèº«ä»½è®¤è¯"
        - "æ•°æ®åŠ å¯†"
        - "è®¿é—®å®¡è®¡"
        - "æ•°æ®è„±æ•"
      
    - name: "ç»å¯†æ•°æ®"
      level: 4
      description: "æœ€é«˜çº§åˆ«çš„æ•æ„Ÿæ•°æ®"
      examples: ["æ ¸å¿ƒç®—æ³•", "é‡å¤§å†³ç­–", "ä¸ªäººéšç§"]
      protection_requirements:
        - "å¤šå› å­è®¤è¯"
        - "ç«¯åˆ°ç«¯åŠ å¯†"
        - "å®Œæ•´å®¡è®¡é“¾"
        - "æ•°æ®æ°´å°"
        - "å®šæœŸå®‰å…¨è¯„ä¼°"

  categories:
    - name: "ä¸ªäººä¿¡æ¯"
      sensitive: true
      regulations: ["GDPR", "ä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•"]
      fields: ["å§“å", "èº«ä»½è¯å·", "æ‰‹æœºå·", "é‚®ç®±", "åœ°å€"]
      
    - name: "è´¢åŠ¡ä¿¡æ¯"
      sensitive: true
      regulations: ["SOXæ³•æ¡ˆ", "ä¼šè®¡æ³•"]
      fields: ["æ”¶å…¥", "æˆæœ¬", "åˆ©æ¶¦", "èµ„äº§", "è´Ÿå€º"]
      
    - name: "å•†ä¸šæœºå¯†"
      sensitive: true
      regulations: ["å•†ä¸šç§˜å¯†ä¿æŠ¤æ³•"]
      fields: ["å®¢æˆ·åå•", "ä»·æ ¼ç­–ç•¥", "å¸‚åœºè®¡åˆ’"]
```

#### 2. æ•°æ®æ ‡å‡†åŒ–ç®¡ç†
```sql
-- æ•°æ®æ ‡å‡†å®šä¹‰è¡¨
CREATE TABLE data_standards (
    standard_id String,
    standard_name String,
    category String,
    data_type String,
    format_rule String,
    validation_rule String,
    description String,
    examples Array(String),
    create_time DateTime,
    update_time DateTime,
    status Enum8('ACTIVE'=1, 'INACTIVE'=0)
) ENGINE = MergeTree()
ORDER BY (category, standard_name);

-- æ’å…¥æ ‡å‡†æ•°æ®
INSERT INTO data_standards VALUES
('STD_001', 'å®¢æˆ·ç¼–ç æ ‡å‡†', 'å®¢æˆ·ç®¡ç†', 'String', '^C[0-9]{8}$', 'length=9 AND startsWith(C)', 'å®¢æˆ·ç¼–ç ä»¥Cå¼€å¤´ï¼Œåè·Ÿ8ä½æ•°å­—', ['C12345678'], now(), now(), 1),
('STD_002', 'å‘˜å·¥ç¼–ç æ ‡å‡†', 'äººåŠ›èµ„æº', 'String', '^E[0-9]{6}$', 'length=7 AND startsWith(E)', 'å‘˜å·¥ç¼–ç ä»¥Eå¼€å¤´ï¼Œåè·Ÿ6ä½æ•°å­—', ['E123456'], now(), now(), 1),
('STD_003', 'å•†å“ç¼–ç æ ‡å‡†', 'å•†å“ç®¡ç†', 'String', '^P[0-9]{10}$', 'length=11 AND startsWith(P)', 'å•†å“ç¼–ç ä»¥På¼€å¤´ï¼Œåè·Ÿ10ä½æ•°å­—', ['P1234567890'], now(), now(), 1),
('STD_004', 'é‡‘é¢æ ¼å¼æ ‡å‡†', 'è´¢åŠ¡ç®¡ç†', 'Decimal', 'Decimal(15,2)', 'value >= 0', 'é‡‘é¢ä¿ç•™2ä½å°æ•°ï¼Œéè´Ÿæ•°', ['1234.56'], now(), now(), 1),
('STD_005', 'æ—¥æœŸæ ¼å¼æ ‡å‡†', 'é€šç”¨', 'Date', 'YYYY-MM-DD', 'isValidDate', 'æ ‡å‡†æ—¥æœŸæ ¼å¼', ['2024-08-14'], now(), now(), 1);

-- æ•°æ®è´¨é‡è§„åˆ™è¡¨
CREATE TABLE data_quality_rules (
    rule_id String,
    rule_name String,
    table_name String,
    column_name String,
    rule_type Enum8('COMPLETENESS'=1, 'ACCURACY'=2, 'CONSISTENCY'=3, 'VALIDITY'=4),
    rule_expression String,
    threshold Decimal(5,4),
    severity Enum8('LOW'=1, 'MEDIUM'=2, 'HIGH'=3, 'CRITICAL'=4),
    description String,
    create_time DateTime,
    update_time DateTime,
    is_active UInt8 DEFAULT 1
) ENGINE = MergeTree()
ORDER BY (table_name, column_name, rule_type);

-- æ’å…¥è´¨é‡è§„åˆ™
INSERT INTO data_quality_rules VALUES
('RULE_001', 'å®¢æˆ·åç§°å®Œæ•´æ€§æ£€æŸ¥', 'dim_customer', 'customer_name', 1, 'customer_name IS NOT NULL AND customer_name != \'\'', 0.95, 3, 'å®¢æˆ·åç§°ä¸èƒ½ä¸ºç©º', now(), now(), 1),
('RULE_002', 'è®¢å•é‡‘é¢å‡†ç¡®æ€§æ£€æŸ¥', 'fact_orders', 'order_amount', 2, 'order_amount > 0 AND order_amount < 1000000', 0.99, 3, 'è®¢å•é‡‘é¢å¿…é¡»åœ¨åˆç†èŒƒå›´å†…', now(), now(), 1),
('RULE_003', 'å‘˜å·¥éƒ¨é—¨ä¸€è‡´æ€§æ£€æŸ¥', 'dim_employee', 'department_id', 3, 'department_id IN (SELECT department_id FROM dim_department)', 1.0, 4, 'å‘˜å·¥éƒ¨é—¨å¿…é¡»å­˜åœ¨äºéƒ¨é—¨è¡¨ä¸­', now(), now(), 1);
```

## ğŸ” æ•°æ®å®‰å…¨æ¶æ„

### 1. è®¿é—®æ§åˆ¶ä½“ç³»

#### åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)
```java
/**
 * æ•°æ®è®¿é—®æ§åˆ¶æœåŠ¡
 */
@Service
@Slf4j
public class DataAccessControlService {
    
    @Autowired
    private UserRoleRepository userRoleRepository;
    
    @Autowired
    private RolePermissionRepository rolePermissionRepository;
    
    @Autowired
    private DataClassificationService classificationService;
    
    /**
     * æ£€æŸ¥æ•°æ®è®¿é—®æƒé™
     */
    public boolean checkDataAccess(String userId, String resourcePath, String operation) {
        // 1. è·å–ç”¨æˆ·è§’è‰²
        List<String> userRoles = getUserRoles(userId);
        
        // 2. è·å–èµ„æºçš„æ•°æ®åˆ†ç±»çº§åˆ«
        DataClassification classification = classificationService.getClassification(resourcePath);
        
        // 3. æ£€æŸ¥è§’è‰²æƒé™
        for (String role : userRoles) {
            if (hasPermission(role, resourcePath, operation, classification)) {
                // 4. è®°å½•è®¿é—®æ—¥å¿—
                logDataAccess(userId, resourcePath, operation, true);
                return true;
            }
        }
        
        // 5. è®°å½•æ‹’ç»è®¿é—®æ—¥å¿—
        logDataAccess(userId, resourcePath, operation, false);
        return false;
    }
    
    /**
     * åŠ¨æ€æ•°æ®è„±æ•
     */
    public Object maskSensitiveData(Object data, String userId, DataClassification classification) {
        if (classification.getLevel() <= 2) {
            return data; // å…¬å¼€å’Œå†…éƒ¨æ•°æ®ä¸è„±æ•
        }
        
        // è·å–ç”¨æˆ·çš„è„±æ•æƒé™
        Set<String> unmaskFields = getUnmaskPermissions(userId);
        
        if (data instanceof Map) {
            Map<String, Object> maskedData = new HashMap<>();
            Map<String, Object> originalData = (Map<String, Object>) data;
            
            for (Map.Entry<String, Object> entry : originalData.entrySet()) {
                String fieldName = entry.getKey();
                Object fieldValue = entry.getValue();
                
                if (isSensitiveField(fieldName) && !unmaskFields.contains(fieldName)) {
                    maskedData.put(fieldName, maskFieldValue(fieldName, fieldValue));
                } else {
                    maskedData.put(fieldName, fieldValue);
                }
            }
            
            return maskedData;
        }
        
        return data;
    }
    
    private Object maskFieldValue(String fieldName, Object value) {
        if (value == null) return null;
        
        String strValue = value.toString();
        
        switch (fieldName.toLowerCase()) {
            case "phone":
            case "mobile":
                return maskPhone(strValue);
            case "email":
                return maskEmail(strValue);
            case "idcard":
            case "id_card":
                return maskIdCard(strValue);
            case "bankcard":
            case "bank_card":
                return maskBankCard(strValue);
            case "name":
            case "customer_name":
                return maskName(strValue);
            default:
                return "***";
        }
    }
    
    private String maskPhone(String phone) {
        if (phone.length() >= 11) {
            return phone.substring(0, 3) + "****" + phone.substring(7);
        }
        return "***";
    }
    
    private String maskEmail(String email) {
        int atIndex = email.indexOf('@');
        if (atIndex > 0) {
            String prefix = email.substring(0, Math.min(3, atIndex));
            String suffix = email.substring(atIndex);
            return prefix + "***" + suffix;
        }
        return "***";
    }
    
    private String maskIdCard(String idCard) {
        if (idCard.length() >= 18) {
            return idCard.substring(0, 6) + "********" + idCard.substring(14);
        }
        return "***";
    }
    
    private String maskName(String name) {
        if (name.length() <= 1) {
            return "*";
        } else if (name.length() == 2) {
            return name.charAt(0) + "*";
        } else {
            return name.charAt(0) + "*".repeat(name.length() - 2) + name.charAt(name.length() - 1);
        }
    }
}

/**
 * è¡Œçº§æ•°æ®å®‰å…¨ç­–ç•¥
 */
@Component
public class RowLevelSecurityPolicy {
    
    /**
     * æ„å»ºè¡Œçº§å®‰å…¨è¿‡æ»¤æ¡ä»¶
     */
    public String buildSecurityFilter(String userId, String tableName) {
        UserContext userContext = getCurrentUserContext(userId);
        
        switch (tableName) {
            case "fact_sales":
                return buildSalesSecurityFilter(userContext);
            case "dim_customer":
                return buildCustomerSecurityFilter(userContext);
            case "dim_employee":
                return buildEmployeeSecurityFilter(userContext);
            default:
                return "1=1"; // é»˜è®¤æ— é™åˆ¶
        }
    }
    
    private String buildSalesSecurityFilter(UserContext userContext) {
        if (userContext.hasRole("ADMIN")) {
            return "1=1"; // ç®¡ç†å‘˜å¯ä»¥çœ‹æ‰€æœ‰æ•°æ®
        } else if (userContext.hasRole("MANAGER")) {
            // ç»ç†å¯ä»¥çœ‹æœ¬éƒ¨é—¨æ•°æ®
            return String.format("department_id = '%s'", userContext.getDepartmentId());
        } else if (userContext.hasRole("EMPLOYEE")) {
            // å‘˜å·¥åªèƒ½çœ‹è‡ªå·±çš„æ•°æ®
            return String.format("employee_id = '%s'", userContext.getEmployeeId());
        } else {
            return "1=0"; // æ— æƒé™
        }
    }
    
    private String buildCustomerSecurityFilter(UserContext userContext) {
        if (userContext.hasRole("ADMIN") || userContext.hasRole("MANAGER")) {
            return "1=1";
        } else {
            // æ™®é€šå‘˜å·¥åªèƒ½çœ‹åˆ°è‡ªå·±è´Ÿè´£çš„å®¢æˆ·
            return String.format("responsible_employee_id = '%s'", userContext.getEmployeeId());
        }
    }
}
```

### 2. æ•°æ®åŠ å¯†ç­–ç•¥

#### å¤šå±‚åŠ å¯†æ¶æ„
```java
/**
 * æ•°æ®åŠ å¯†æœåŠ¡
 */
@Service
@Slf4j
public class DataEncryptionService {
    
    private static final String AES_ALGORITHM = "AES/GCM/NoPadding";
    private static final String RSA_ALGORITHM = "RSA/ECB/OAEPWITHSHA-256ANDMGF1PADDING";
    
    @Autowired
    private KeyManagementService keyManagementService;
    
    /**
     * å­—æ®µçº§åŠ å¯†
     */
    public String encryptField(String plaintext, String fieldName, String keyId) {
        try {
            // è·å–å­—æ®µåŠ å¯†å¯†é’¥
            SecretKey fieldKey = keyManagementService.getFieldKey(keyId);
            
            Cipher cipher = Cipher.getInstance(AES_ALGORITHM);
            cipher.init(Cipher.ENCRYPT_MODE, fieldKey);
            
            byte[] encryptedBytes = cipher.doFinal(plaintext.getBytes(StandardCharsets.UTF_8));
            byte[] iv = cipher.getIV();
            
            // ç»„åˆIVå’Œå¯†æ–‡
            byte[] combined = new byte[iv.length + encryptedBytes.length];
            System.arraycopy(iv, 0, combined, 0, iv.length);
            System.arraycopy(encryptedBytes, 0, combined, iv.length, encryptedBytes.length);
            
            return Base64.getEncoder().encodeToString(combined);
            
        } catch (Exception e) {
            log.error("å­—æ®µåŠ å¯†å¤±è´¥: {}", e.getMessage(), e);
            throw new SecurityException("æ•°æ®åŠ å¯†å¤±è´¥");
        }
    }
    
    /**
     * å­—æ®µçº§è§£å¯†
     */
    public String decryptField(String ciphertext, String fieldName, String keyId) {
        try {
            byte[] combined = Base64.getDecoder().decode(ciphertext);
            
            // åˆ†ç¦»IVå’Œå¯†æ–‡
            byte[] iv = new byte[12]; // GCMæ¨¡å¼IVé•¿åº¦ä¸º12å­—èŠ‚
            byte[] encryptedBytes = new byte[combined.length - 12];
            System.arraycopy(combined, 0, iv, 0, 12);
            System.arraycopy(combined, 12, encryptedBytes, 0, encryptedBytes.length);
            
            SecretKey fieldKey = keyManagementService.getFieldKey(keyId);
            
            Cipher cipher = Cipher.getInstance(AES_ALGORITHM);
            GCMParameterSpec gcmSpec = new GCMParameterSpec(128, iv);
            cipher.init(Cipher.DECRYPT_MODE, fieldKey, gcmSpec);
            
            byte[] decryptedBytes = cipher.doFinal(encryptedBytes);
            return new String(decryptedBytes, StandardCharsets.UTF_8);
            
        } catch (Exception e) {
            log.error("å­—æ®µè§£å¯†å¤±è´¥: {}", e.getMessage(), e);
            throw new SecurityException("æ•°æ®è§£å¯†å¤±è´¥");
        }
    }
    
    /**
     * æ–‡ä»¶çº§åŠ å¯†
     */
    public void encryptFile(String inputFilePath, String outputFilePath, String keyId) {
        try (FileInputStream fis = new FileInputStream(inputFilePath);
             FileOutputStream fos = new FileOutputStream(outputFilePath)) {
            
            SecretKey fileKey = keyManagementService.getFileKey(keyId);
            
            Cipher cipher = Cipher.getInstance(AES_ALGORITHM);
            cipher.init(Cipher.ENCRYPT_MODE, fileKey);
            
            // å†™å…¥IV
            byte[] iv = cipher.getIV();
            fos.write(iv);
            
            // åŠ å¯†æ–‡ä»¶å†…å®¹
            try (CipherOutputStream cos = new CipherOutputStream(fos, cipher)) {
                byte[] buffer = new byte[8192];
                int bytesRead;
                while ((bytesRead = fis.read(buffer)) != -1) {
                    cos.write(buffer, 0, bytesRead);
                }
            }
            
            log.info("æ–‡ä»¶åŠ å¯†å®Œæˆ: {} -> {}", inputFilePath, outputFilePath);
            
        } catch (Exception e) {
            log.error("æ–‡ä»¶åŠ å¯†å¤±è´¥: {}", e.getMessage(), e);
            throw new SecurityException("æ–‡ä»¶åŠ å¯†å¤±è´¥");
        }
    }
}

/**
 * å¯†é’¥ç®¡ç†æœåŠ¡
 */
@Service
@Slf4j
public class KeyManagementService {
    
    @Autowired
    private HSMClient hsmClient; // ç¡¬ä»¶å®‰å…¨æ¨¡å—å®¢æˆ·ç«¯
    
    private final Map<String, SecretKey> keyCache = new ConcurrentHashMap<>();
    
    /**
     * è·å–å­—æ®µåŠ å¯†å¯†é’¥
     */
    public SecretKey getFieldKey(String keyId) {
        return keyCache.computeIfAbsent(keyId, this::loadFieldKeyFromHSM);
    }
    
    /**
     * å¯†é’¥è½®æ¢
     */
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void rotateKeys() {
        log.info("å¼€å§‹æ‰§è¡Œå¯†é’¥è½®æ¢");
        
        try {
            // ç”Ÿæˆæ–°çš„ä¸»å¯†é’¥
            String newMasterKeyId = hsmClient.generateMasterKey();
            
            // é‡æ–°åŠ å¯†æ‰€æœ‰å­—æ®µå¯†é’¥
            reencryptFieldKeys(newMasterKeyId);
            
            // æ›´æ–°å¯†é’¥ç‰ˆæœ¬
            updateKeyVersion(newMasterKeyId);
            
            // æ¸…ç†ç¼“å­˜
            keyCache.clear();
            
            log.info("å¯†é’¥è½®æ¢å®Œæˆï¼Œæ–°ä¸»å¯†é’¥ID: {}", newMasterKeyId);
            
        } catch (Exception e) {
            log.error("å¯†é’¥è½®æ¢å¤±è´¥: {}", e.getMessage(), e);
            // å‘é€å‘Šè­¦
            alertService.sendAlert("å¯†é’¥è½®æ¢å¤±è´¥", e.getMessage());
        }
    }
    
    private SecretKey loadFieldKeyFromHSM(String keyId) {
        try {
            return hsmClient.getKey(keyId);
        } catch (Exception e) {
            log.error("ä»HSMåŠ è½½å¯†é’¥å¤±è´¥: {}", e.getMessage(), e);
            throw new SecurityException("å¯†é’¥åŠ è½½å¤±è´¥");
        }
    }
}
```

### 3. å®¡è®¡æ—¥å¿—ç³»ç»Ÿ

#### å®¡è®¡æ—¥å¿—è®¾è®¡
```sql
-- æ•°æ®è®¿é—®å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_data_access (
    log_id String,
    user_id String,
    user_name String,
    session_id String,
    access_time DateTime,
    resource_type String,
    resource_path String,
    operation String,
    access_result Enum8('SUCCESS'=1, 'DENIED'=2, 'ERROR'=3),
    ip_address String,
    user_agent String,
    request_params String,
    response_size UInt64,
    execution_time UInt32,
    error_message String,
    risk_score UInt8,
    create_time DateTime DEFAULT now()
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(access_time)
ORDER BY (user_id, access_time)
TTL access_time + INTERVAL 2 YEAR;

-- æ•°æ®å˜æ›´å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_data_changes (
    log_id String,
    user_id String,
    user_name String,
    change_time DateTime,
    table_name String,
    operation_type Enum8('INSERT'=1, 'UPDATE'=2, 'DELETE'=3),
    record_id String,
    old_values String,
    new_values String,
    change_reason String,
    approval_status Enum8('PENDING'=1, 'APPROVED'=2, 'REJECTED'=3),
    approver_id String,
    create_time DateTime DEFAULT now()
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(change_time)
ORDER BY (table_name, change_time)
TTL change_time + INTERVAL 7 YEAR;

-- ç³»ç»Ÿå®‰å…¨äº‹ä»¶æ—¥å¿—è¡¨
CREATE TABLE audit_security_events (
    event_id String,
    event_type String,
    event_time DateTime,
    severity Enum8('LOW'=1, 'MEDIUM'=2, 'HIGH'=3, 'CRITICAL'=4),
    source_ip String,
    user_id String,
    event_description String,
    event_details String,
    handled UInt8 DEFAULT 0,
    handler_id String,
    handle_time DateTime,
    create_time DateTime DEFAULT now()
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(event_time)
ORDER BY (event_type, event_time)
TTL event_time + INTERVAL 5 YEAR;
```

#### å®¡è®¡æ—¥å¿—åˆ†æ
```java
/**
 * å®¡è®¡æ—¥å¿—åˆ†ææœåŠ¡
 */
@Service
@Slf4j
public class AuditAnalysisService {
    
    @Autowired
    private ClickHouseTemplate clickHouseTemplate;
    
    @Autowired
    private AlertService alertService;
    
    /**
     * å¼‚å¸¸è®¿é—®è¡Œä¸ºæ£€æµ‹
     */
    @Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void detectAnomalousAccess() {
        // 1. æ£€æµ‹å¼‚å¸¸è®¿é—®é¢‘ç‡
        detectHighFrequencyAccess();
        
        // 2. æ£€æµ‹å¼‚å¸¸è®¿é—®æ—¶é—´
        detectOffHoursAccess();
        
        // 3. æ£€æµ‹å¼‚å¸¸è®¿é—®åœ°ç‚¹
        detectUnusualLocationAccess();
        
        // 4. æ£€æµ‹æƒé™æå‡å°è¯•
        detectPrivilegeEscalation();
    }
    
    private void detectHighFrequencyAccess() {
        String sql = """
            SELECT 
                user_id,
                user_name,
                count() as access_count,
                uniq(resource_path) as unique_resources
            FROM audit_data_access
            WHERE access_time >= now() - INTERVAL 1 HOUR
            GROUP BY user_id, user_name
            HAVING access_count > 1000 OR unique_resources > 100
            ORDER BY access_count DESC
            """;
        
        List<Map<String, Object>> results = clickHouseTemplate.queryForList(sql);
        
        for (Map<String, Object> result : results) {
            String userId = (String) result.get("user_id");
            String userName = (String) result.get("user_name");
            Long accessCount = (Long) result.get("access_count");
            
            SecurityEvent event = SecurityEvent.builder()
                .eventType("HIGH_FREQUENCY_ACCESS")
                .severity(SecuritySeverity.HIGH)
                .userId(userId)
                .description(String.format("ç”¨æˆ· %s åœ¨1å°æ—¶å†…è®¿é—®äº† %d æ¬¡æ•°æ®", userName, accessCount))
                .build();
            
            handleSecurityEvent(event);
        }
    }
    
    private void detectOffHoursAccess() {
        String sql = """
            SELECT 
                user_id,
                user_name,
                count() as access_count,
                groupArray(resource_path) as accessed_resources
            FROM audit_data_access
            WHERE access_time >= today()
              AND (toHour(access_time) < 8 OR toHour(access_time) > 22)
              AND resource_type = 'SENSITIVE_DATA'
            GROUP BY user_id, user_name
            HAVING access_count > 10
            """;
        
        List<Map<String, Object>> results = clickHouseTemplate.queryForList(sql);
        
        for (Map<String, Object> result : results) {
            SecurityEvent event = SecurityEvent.builder()
                .eventType("OFF_HOURS_ACCESS")
                .severity(SecuritySeverity.MEDIUM)
                .userId((String) result.get("user_id"))
                .description("éå·¥ä½œæ—¶é—´è®¿é—®æ•æ„Ÿæ•°æ®")
                .build();
            
            handleSecurityEvent(event);
        }
    }
    
    /**
     * ç”Ÿæˆåˆè§„æŠ¥å‘Š
     */
    public ComplianceReport generateComplianceReport(String reportType, LocalDate startDate, LocalDate endDate) {
        switch (reportType) {
            case "GDPR":
                return generateGDPRReport(startDate, endDate);
            case "SOX":
                return generateSOXReport(startDate, endDate);
            case "PERSONAL_INFO":
                return generatePersonalInfoReport(startDate, endDate);
            default:
                throw new IllegalArgumentException("ä¸æ”¯æŒçš„æŠ¥å‘Šç±»å‹: " + reportType);
        }
    }
    
    private ComplianceReport generateGDPRReport(LocalDate startDate, LocalDate endDate) {
        // GDPRåˆè§„æŠ¥å‘Š
        String sql = """
            SELECT 
                'personal_data_access' as metric_name,
                count() as metric_value,
                'Total personal data access requests' as description
            FROM audit_data_access
            WHERE access_time BETWEEN ? AND ?
              AND resource_path LIKE '%personal%'
            
            UNION ALL
            
            SELECT 
                'data_subject_requests' as metric_name,
                count() as metric_value,
                'Data subject access requests' as description
            FROM audit_data_access
            WHERE access_time BETWEEN ? AND ?
              AND operation = 'DATA_SUBJECT_REQUEST'
            """;
        
        List<Map<String, Object>> metrics = clickHouseTemplate.queryForList(sql, 
            startDate, endDate, startDate, endDate);
        
        return ComplianceReport.builder()
            .reportType("GDPR")
            .startDate(startDate)
            .endDate(endDate)
            .metrics(metrics)
            .generateTime(LocalDateTime.now())
            .build();
    }
    
    private void handleSecurityEvent(SecurityEvent event) {
        // è®°å½•å®‰å…¨äº‹ä»¶
        logSecurityEvent(event);
        
        // å‘é€å‘Šè­¦
        if (event.getSeverity().ordinal() >= SecuritySeverity.HIGH.ordinal()) {
            alertService.sendSecurityAlert(event);
        }
        
        // è‡ªåŠ¨å“åº”
        if (event.getSeverity() == SecuritySeverity.CRITICAL) {
            autoResponseToThreat(event);
        }
    }
    
    private void autoResponseToThreat(SecurityEvent event) {
        switch (event.getEventType()) {
            case "HIGH_FREQUENCY_ACCESS":
                // ä¸´æ—¶é™åˆ¶ç”¨æˆ·è®¿é—®é¢‘ç‡
                rateLimitService.limitUser(event.getUserId(), Duration.ofHours(1));
                break;
            case "PRIVILEGE_ESCALATION":
                // ä¸´æ—¶ç¦ç”¨ç”¨æˆ·è´¦æˆ·
                userService.temporaryDisableUser(event.getUserId(), Duration.ofHours(24));
                break;
            case "DATA_EXFILTRATION":
                // é˜»æ­¢ç”¨æˆ·æ•°æ®å¯¼å‡º
                dataExportService.blockUser(event.getUserId());
                break;
        }
    }
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024å¹´8æœˆ14æ—¥  
**ç»´æŠ¤å›¢é˜Ÿ**: æ•°æ®æ²»ç†å›¢é˜Ÿ  

> ğŸ›¡ï¸ **å®‰å…¨æé†’**: æ•°æ®æ²»ç†å’Œå®‰å…¨ç®¡ç†æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦å®šæœŸè¯„ä¼°å’Œæ›´æ–°ç­–ç•¥ã€‚æœ¬æ–‡æ¡£æä¾›äº†å®Œæ•´çš„æ²»ç†æ¡†æ¶å’ŒæŠ€æœ¯å®ç°æ–¹æ¡ˆï¼Œåœ¨å®é™…åº”ç”¨ä¸­è¯·æ ¹æ®å…·ä½“çš„åˆè§„è¦æ±‚å’Œå®‰å…¨å¨èƒè¿›è¡Œè°ƒæ•´ã€‚
