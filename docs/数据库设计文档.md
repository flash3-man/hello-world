# 经营分析APP数据库设计文档

## 📊 数据库架构概览

### 数据库分层设计
```
┌─────────────────────────────────────────────────────────────┐
│                        应用层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 移动端APP   │  │ 管理后台    │  │ 数据可视化  │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        服务层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 用户服务    │  │ 数据服务    │  │ 分析服务    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      数据存储层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 业务数据库  │  │ 数据仓库    │  │ 缓存层      │        │
│  │ (MySQL)    │  │ (ClickHouse)│  │ (Redis)     │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## 🗄️ 业务数据库设计 (MySQL)

### 数据库实例规划
- **用户权限库** (user_db): 存储用户、角色、权限相关数据
- **业务数据库** (business_db): 存储核心业务数据
- **任务调度库** (job_db): 存储任务配置和执行日志
- **日志数据库** (log_db): 存储系统操作日志

### 核心数据表设计

#### 1. 用户权限模块

```sql
-- 用户表
CREATE TABLE sys_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    password VARCHAR(100) NOT NULL COMMENT '密码(BCrypt加密)',
    real_name VARCHAR(50) COMMENT '真实姓名',
    phone VARCHAR(20) COMMENT '手机号',
    email VARCHAR(100) COMMENT '邮箱',
    avatar VARCHAR(200) COMMENT '头像URL',
    status TINYINT DEFAULT 1 COMMENT '状态:1启用,0禁用',
    dept_id BIGINT COMMENT '部门ID',
    last_login_time DATETIME COMMENT '最后登录时间',
    last_login_ip VARCHAR(50) COMMENT '最后登录IP',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    
    INDEX idx_username (username),
    INDEX idx_dept_id (dept_id),
    INDEX idx_status (status),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';

-- 部门表
CREATE TABLE sys_dept (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '部门ID',
    parent_id BIGINT DEFAULT 0 COMMENT '父部门ID',
    dept_name VARCHAR(50) NOT NULL COMMENT '部门名称',
    dept_code VARCHAR(50) NOT NULL UNIQUE COMMENT '部门编码',
    leader_id BIGINT COMMENT '部门负责人ID',
    phone VARCHAR(20) COMMENT '联系电话',
    email VARCHAR(100) COMMENT '邮箱',
    sort_order INT DEFAULT 0 COMMENT '显示顺序',
    status TINYINT DEFAULT 1 COMMENT '状态:1启用,0禁用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_parent_id (parent_id),
    INDEX idx_dept_code (dept_code),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='部门表';

-- 角色表
CREATE TABLE sys_role (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '角色ID',
    role_name VARCHAR(50) NOT NULL COMMENT '角色名称',
    role_code VARCHAR(50) NOT NULL UNIQUE COMMENT '角色编码',
    description VARCHAR(200) COMMENT '角色描述',
    data_scope TINYINT DEFAULT 1 COMMENT '数据范围:1全部,2本部门,3本部门及下级,4仅本人',
    status TINYINT DEFAULT 1 COMMENT '状态:1启用,0禁用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_role_code (role_code),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色表';

-- 权限表
CREATE TABLE sys_permission (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '权限ID',
    parent_id BIGINT DEFAULT 0 COMMENT '父级权限ID',
    permission_name VARCHAR(50) NOT NULL COMMENT '权限名称',
    permission_code VARCHAR(100) NOT NULL COMMENT '权限编码',
    permission_type TINYINT NOT NULL COMMENT '权限类型:1菜单,2按钮,3接口',
    path VARCHAR(200) COMMENT '路由路径',
    component VARCHAR(200) COMMENT '组件路径',
    icon VARCHAR(50) COMMENT '图标',
    sort_order INT DEFAULT 0 COMMENT '排序',
    visible TINYINT DEFAULT 1 COMMENT '是否显示:1显示,0隐藏',
    status TINYINT DEFAULT 1 COMMENT '状态:1启用,0禁用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_parent_id (parent_id),
    INDEX idx_permission_code (permission_code),
    INDEX idx_permission_type (permission_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='权限表';

-- 用户角色关联表
CREATE TABLE sys_user_role (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    role_id BIGINT NOT NULL COMMENT '角色ID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    UNIQUE KEY uk_user_role (user_id, role_id),
    INDEX idx_user_id (user_id),
    INDEX idx_role_id (role_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户角色关联表';

-- 角色权限关联表
CREATE TABLE sys_role_permission (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    role_id BIGINT NOT NULL COMMENT '角色ID',
    permission_id BIGINT NOT NULL COMMENT '权限ID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    UNIQUE KEY uk_role_permission (role_id, permission_id),
    INDEX idx_role_id (role_id),
    INDEX idx_permission_id (permission_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色权限关联表';
```

#### 2. 业务数据模块

```sql
-- 数据版本表
CREATE TABLE data_version (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '版本ID',
    version_code VARCHAR(50) NOT NULL UNIQUE COMMENT '版本号',
    version_name VARCHAR(100) COMMENT '版本名称',
    data_date DATE NOT NULL COMMENT '数据日期',
    task_type VARCHAR(50) COMMENT '任务类型',
    status TINYINT DEFAULT 0 COMMENT '状态:0生成中,1已完成,2失败,3已回滚',
    is_active TINYINT DEFAULT 0 COMMENT '是否当前活跃版本:1是,0否',
    start_time DATETIME COMMENT '开始时间',
    end_time DATETIME COMMENT '结束时间',
    processed_records INT DEFAULT 0 COMMENT '处理记录数',
    error_msg TEXT COMMENT '错误信息',
    rollback_reason VARCHAR(500) COMMENT '回滚原因',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    INDEX idx_version_code (version_code),
    INDEX idx_data_date (data_date),
    INDEX idx_status (status),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='数据版本表';

-- 员工基础信息表
CREATE TABLE employee_info (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '员工ID',
    employee_code VARCHAR(50) NOT NULL UNIQUE COMMENT '员工编码',
    employee_name VARCHAR(50) NOT NULL COMMENT '员工姓名',
    dept_id BIGINT COMMENT '部门ID',
    dept_name VARCHAR(50) COMMENT '部门名称',
    position VARCHAR(50) COMMENT '职位',
    level VARCHAR(20) COMMENT '级别',
    hire_date DATE COMMENT '入职日期',
    phone VARCHAR(20) COMMENT '手机号',
    email VARCHAR(100) COMMENT '邮箱',
    status TINYINT DEFAULT 1 COMMENT '状态:1在职,0离职',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_employee_code (employee_code),
    INDEX idx_dept_id (dept_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='员工基础信息表';

-- 员工业绩数据表
CREATE TABLE employee_performance (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    version_id BIGINT NOT NULL COMMENT '数据版本ID',
    employee_id BIGINT NOT NULL COMMENT '员工ID',
    employee_name VARCHAR(50) NOT NULL COMMENT '员工姓名',
    employee_code VARCHAR(50) NOT NULL COMMENT '员工编码',
    dept_id BIGINT COMMENT '部门ID',
    dept_name VARCHAR(50) COMMENT '部门名称',
    data_date DATE NOT NULL COMMENT '数据日期',
    
    -- 订单相关指标
    order_amount DECIMAL(15,2) DEFAULT 0.00 COMMENT '订单金额',
    order_count INT DEFAULT 0 COMMENT '订单数量',
    order_customers INT DEFAULT 0 COMMENT '订单客户数',
    order_products INT DEFAULT 0 COMMENT '订单商品数',
    order_quantity INT DEFAULT 0 COMMENT '订单商品数量',
    
    -- 销售相关指标
    sales_amount DECIMAL(15,2) DEFAULT 0.00 COMMENT '销售金额',
    sales_count INT DEFAULT 0 COMMENT '销售单数',
    net_sales DECIMAL(15,2) DEFAULT 0.00 COMMENT '净销售额',
    sales_profit DECIMAL(15,2) DEFAULT 0.00 COMMENT '销售毛利',
    profit_rate DECIMAL(5,2) DEFAULT 0.00 COMMENT '毛利率(%)',
    
    -- 退货相关指标
    return_amount DECIMAL(15,2) DEFAULT 0.00 COMMENT '退货金额',
    return_order_count INT DEFAULT 0 COMMENT '退货订单数',
    return_rate DECIMAL(5,2) DEFAULT 0.00 COMMENT '退货率(%)',
    
    -- 客户相关指标
    visit_customers INT DEFAULT 0 COMMENT '拜访客户数',
    distribution_customers INT DEFAULT 0 COMMENT '铺货客户数',
    purchase_customers INT DEFAULT 0 COMMENT '进货客户数',
    avg_order_value DECIMAL(10,2) DEFAULT 0.00 COMMENT '客单价',
    
    -- 商品相关指标
    outbound_products INT DEFAULT 0 COMMENT '出货商品数',
    return_products INT DEFAULT 0 COMMENT '退货商品数',
    sales_quantity INT DEFAULT 0 COMMENT '销售商品数量',
    return_quantity INT DEFAULT 0 COMMENT '退货商品数量',
    gift_cost DECIMAL(10,2) DEFAULT 0.00 COMMENT '赠品成本',
    
    -- 扩展字段
    ext_field1 VARCHAR(100) COMMENT '扩展字段1',
    ext_field2 VARCHAR(100) COMMENT '扩展字段2',
    ext_field3 DECIMAL(15,2) COMMENT '扩展字段3',
    
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    UNIQUE KEY uk_version_employee_date (version_id, employee_id, data_date),
    INDEX idx_version_id (version_id),
    INDEX idx_employee_id (employee_id),
    INDEX idx_data_date (data_date),
    INDEX idx_dept_id (dept_id),
    INDEX idx_sales_amount (sales_amount),
    INDEX idx_order_amount (order_amount)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='员工业绩数据表';

-- 客户信息表
CREATE TABLE customer_info (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '客户ID',
    customer_code VARCHAR(50) NOT NULL UNIQUE COMMENT '客户编码',
    customer_name VARCHAR(100) NOT NULL COMMENT '客户名称',
    customer_type TINYINT COMMENT '客户类型:1直销,2经销,3代理',
    level VARCHAR(20) COMMENT '客户级别',
    area_code VARCHAR(50) COMMENT '区域编码',
    area_name VARCHAR(100) COMMENT '区域名称',
    address VARCHAR(200) COMMENT '客户地址',
    contact_person VARCHAR(50) COMMENT '联系人',
    contact_phone VARCHAR(20) COMMENT '联系电话',
    credit_limit DECIMAL(15,2) DEFAULT 0.00 COMMENT '信用额度',
    status TINYINT DEFAULT 1 COMMENT '状态:1正常,0停用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_customer_code (customer_code),
    INDEX idx_customer_type (customer_type),
    INDEX idx_area_code (area_code),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='客户信息表';

-- 商品信息表
CREATE TABLE product_info (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '商品ID',
    product_code VARCHAR(50) NOT NULL UNIQUE COMMENT '商品编码',
    product_name VARCHAR(100) NOT NULL COMMENT '商品名称',
    category_id BIGINT COMMENT '分类ID',
    category_name VARCHAR(50) COMMENT '分类名称',
    brand VARCHAR(50) COMMENT '品牌',
    specification VARCHAR(100) COMMENT '规格',
    unit VARCHAR(20) COMMENT '单位',
    cost_price DECIMAL(10,2) DEFAULT 0.00 COMMENT '成本价',
    sale_price DECIMAL(10,2) DEFAULT 0.00 COMMENT '销售价',
    status TINYINT DEFAULT 1 COMMENT '状态:1上架,0下架',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_product_code (product_code),
    INDEX idx_category_id (category_id),
    INDEX idx_brand (brand),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品信息表';
```

#### 3. 任务调度模块

```sql
-- 数据同步任务表
CREATE TABLE data_sync_task (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '任务ID',
    task_name VARCHAR(100) NOT NULL COMMENT '任务名称',
    task_code VARCHAR(50) NOT NULL UNIQUE COMMENT '任务编码',
    task_type VARCHAR(20) NOT NULL COMMENT '任务类型:erp_sync,data_calc,report_gen',
    task_group VARCHAR(50) DEFAULT 'DEFAULT' COMMENT '任务分组',
    description TEXT COMMENT '任务描述',
    
    -- 数据源配置
    source_system VARCHAR(50) COMMENT '源系统',
    source_config JSON COMMENT '源系统配置',
    target_table VARCHAR(100) COMMENT '目标表',
    
    -- 执行配置
    cron_expression VARCHAR(50) COMMENT 'Cron表达式',
    timeout_seconds INT DEFAULT 3600 COMMENT '超时时间(秒)',
    retry_count INT DEFAULT 3 COMMENT '重试次数',
    
    -- SQL脚本
    sql_script TEXT COMMENT 'SQL脚本',
    param_config JSON COMMENT '参数配置',
    
    -- 状态信息
    status TINYINT DEFAULT 1 COMMENT '状态:1启用,0禁用',
    last_exec_time DATETIME COMMENT '最后执行时间',
    next_exec_time DATETIME COMMENT '下次执行时间',
    exec_count INT DEFAULT 0 COMMENT '执行次数',
    success_count INT DEFAULT 0 COMMENT '成功次数',
    fail_count INT DEFAULT 0 COMMENT '失败次数',
    
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    
    INDEX idx_task_code (task_code),
    INDEX idx_task_type (task_type),
    INDEX idx_status (status),
    INDEX idx_next_exec_time (next_exec_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='数据同步任务表';

-- 任务执行日志表
CREATE TABLE task_exec_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '日志ID',
    task_id BIGINT NOT NULL COMMENT '任务ID',
    exec_id VARCHAR(50) NOT NULL COMMENT '执行ID(UUID)',
    trigger_type TINYINT NOT NULL COMMENT '触发类型:1定时,2手动,3重试',
    
    -- 执行信息
    start_time DATETIME NOT NULL COMMENT '开始时间',
    end_time DATETIME COMMENT '结束时间',
    exec_duration INT COMMENT '执行时长(秒)',
    exec_status TINYINT NOT NULL COMMENT '执行状态:0执行中,1成功,2失败,3超时,4取消',
    
    -- 执行结果
    processed_records INT DEFAULT 0 COMMENT '处理记录数',
    success_records INT DEFAULT 0 COMMENT '成功记录数',
    fail_records INT DEFAULT 0 COMMENT '失败记录数',
    exec_result TEXT COMMENT '执行结果',
    error_msg TEXT COMMENT '错误信息',
    
    -- 资源使用
    cpu_usage DECIMAL(5,2) COMMENT 'CPU使用率',
    memory_usage DECIMAL(5,2) COMMENT '内存使用率',
    
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    INDEX idx_task_id (task_id),
    INDEX idx_exec_id (exec_id),
    INDEX idx_start_time (start_time),
    INDEX idx_exec_status (exec_status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='任务执行日志表';
```

#### 4. 系统日志模块

```sql
-- 操作日志表
CREATE TABLE sys_operation_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '日志ID',
    trace_id VARCHAR(50) COMMENT '链路追踪ID',
    user_id BIGINT COMMENT '操作用户ID',
    username VARCHAR(50) COMMENT '用户名',
    real_name VARCHAR(50) COMMENT '真实姓名',
    
    -- 操作信息
    operation VARCHAR(100) COMMENT '操作内容',
    business_type VARCHAR(50) COMMENT '业务类型',
    method VARCHAR(10) COMMENT '请求方法',
    url VARCHAR(200) COMMENT '请求URL',
    
    -- 请求信息
    ip VARCHAR(50) COMMENT 'IP地址',
    location VARCHAR(100) COMMENT 'IP归属地',
    user_agent VARCHAR(500) COMMENT '用户代理',
    request_params TEXT COMMENT '请求参数',
    
    -- 响应信息
    response_data TEXT COMMENT '响应数据',
    exec_time INT COMMENT '执行时间(ms)',
    status TINYINT COMMENT '状态:1成功,0失败',
    error_msg TEXT COMMENT '错误信息',
    
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    INDEX idx_user_id (user_id),
    INDEX idx_create_time (create_time),
    INDEX idx_status (status),
    INDEX idx_business_type (business_type),
    INDEX idx_trace_id (trace_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='操作日志表';

-- 登录日志表
CREATE TABLE sys_login_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '日志ID',
    username VARCHAR(50) COMMENT '用户名',
    login_type TINYINT COMMENT '登录类型:1密码,2短信,3扫码',
    ip VARCHAR(50) COMMENT 'IP地址',
    location VARCHAR(100) COMMENT 'IP归属地',
    browser VARCHAR(100) COMMENT '浏览器',
    os VARCHAR(100) COMMENT '操作系统',
    device VARCHAR(100) COMMENT '设备信息',
    status TINYINT COMMENT '状态:1成功,0失败',
    error_msg VARCHAR(500) COMMENT '错误信息',
    login_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '登录时间',
    
    INDEX idx_username (username),
    INDEX idx_login_time (login_time),
    INDEX idx_status (status),
    INDEX idx_ip (ip)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='登录日志表';
```

## 🏢 数据仓库设计 (ClickHouse)

### 数据仓库分层架构

#### ODS层 (Operational Data Store) - 原始数据层
```sql
-- ERP原始订单数据表
CREATE TABLE ods_erp_order (
    order_id String,
    order_no String,
    customer_id String,
    customer_name String,
    employee_id String,
    employee_name String,
    order_date Date,
    order_amount Decimal(15,2),
    order_status String,
    create_time DateTime,
    update_time DateTime,
    etl_date Date DEFAULT today()
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(order_date)
ORDER BY (order_date, employee_id, order_id);

-- ERP原始销售数据表
CREATE TABLE ods_erp_sales (
    sales_id String,
    sales_no String,
    order_id String,
    product_id String,
    product_name String,
    employee_id String,
    customer_id String,
    sales_date Date,
    quantity Int32,
    unit_price Decimal(10,2),
    sales_amount Decimal(15,2),
    cost_amount Decimal(15,2),
    create_time DateTime,
    etl_date Date DEFAULT today()
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(sales_date)
ORDER BY (sales_date, employee_id, product_id);
```

#### DWD层 (Data Warehouse Detail) - 明细数据层
```sql
-- 员工业绩明细表
CREATE TABLE dwd_employee_performance_detail (
    id UInt64,
    version_id String,
    employee_id UInt64,
    employee_name String,
    dept_id UInt64,
    dept_name String,
    data_date Date,

    -- 业务指标
    order_amount Decimal(15,2),
    order_count UInt32,
    sales_amount Decimal(15,2),
    sales_count UInt32,
    profit_amount Decimal(15,2),
    customer_count UInt32,
    product_count UInt32,

    -- 时间维度
    year UInt16,
    quarter UInt8,
    month UInt8,
    week UInt8,
    day_of_year UInt16,

    create_time DateTime DEFAULT now(),
    etl_time DateTime DEFAULT now()
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(data_date)
ORDER BY (data_date, employee_id, dept_id);

-- 客户交易明细表
CREATE TABLE dwd_customer_transaction_detail (
    transaction_id String,
    customer_id UInt64,
    customer_name String,
    employee_id UInt64,
    employee_name String,
    transaction_date Date,
    transaction_type String, -- order, sales, return
    amount Decimal(15,2),
    quantity UInt32,
    product_count UInt32,
    create_time DateTime DEFAULT now()
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(transaction_date)
ORDER BY (transaction_date, customer_id, employee_id);
```

#### DWS层 (Data Warehouse Summary) - 汇总数据层
```sql
-- 员工日汇总表
CREATE TABLE dws_employee_daily_summary (
    employee_id UInt64,
    employee_name String,
    dept_id UInt64,
    dept_name String,
    data_date Date,

    -- 汇总指标
    total_order_amount Decimal(15,2),
    total_order_count UInt32,
    total_sales_amount Decimal(15,2),
    total_sales_count UInt32,
    total_profit_amount Decimal(15,2),
    avg_order_value Decimal(10,2),

    -- 客户指标
    total_customers UInt32,
    new_customers UInt32,
    active_customers UInt32,

    -- 商品指标
    total_products UInt32,
    total_quantity UInt32,

    create_time DateTime DEFAULT now(),
    update_time DateTime DEFAULT now()
) ENGINE = SummingMergeTree()
PARTITION BY toYYYYMM(data_date)
ORDER BY (data_date, employee_id);

-- 部门月汇总表
CREATE TABLE dws_dept_monthly_summary (
    dept_id UInt64,
    dept_name String,
    year_month String, -- YYYY-MM

    -- 部门业绩
    total_sales_amount Decimal(15,2),
    total_order_count UInt32,
    total_profit_amount Decimal(15,2),
    avg_profit_rate Decimal(5,2),

    -- 员工统计
    employee_count UInt32,
    active_employee_count UInt32,
    top_employee_id UInt64,
    top_employee_sales Decimal(15,2),

    create_time DateTime DEFAULT now()
) ENGINE = ReplacingMergeTree()
PARTITION BY substring(year_month, 1, 4)
ORDER BY (year_month, dept_id);
```

#### ADS层 (Application Data Store) - 应用数据层
```sql
-- 移动端员工业绩应用表
CREATE TABLE ads_mobile_employee_performance (
    version_id String,
    employee_id UInt64,
    employee_name String,
    dept_name String,
    data_date Date,

    -- 格式化后的展示数据
    order_amount_display String,
    sales_amount_display String,
    profit_rate_display String,
    rank_in_dept UInt32,
    rank_in_company UInt32,

    -- 同比环比数据
    mom_growth_rate Decimal(5,2), -- 环比增长率
    yoy_growth_rate Decimal(5,2), -- 同比增长率

    -- 预计算的聚合数据
    week_total Decimal(15,2),
    month_total Decimal(15,2),
    quarter_total Decimal(15,2),

    create_time DateTime DEFAULT now()
) ENGINE = ReplacingMergeTree()
PARTITION BY toYYYYMM(data_date)
ORDER BY (data_date, employee_id);
```

## 🔧 数据库优化策略

### 1. 索引优化
```sql
-- 复合索引设计原则
-- 1. 最左前缀原则
-- 2. 区分度高的字段在前
-- 3. 范围查询字段在后

-- 员工业绩表优化索引
ALTER TABLE employee_performance
ADD INDEX idx_query_performance (data_date, dept_id, sales_amount DESC);

ALTER TABLE employee_performance
ADD INDEX idx_employee_date_range (employee_id, data_date);

-- 覆盖索引 (避免回表查询)
ALTER TABLE employee_performance
ADD INDEX idx_cover_list (data_date, dept_id, employee_id, employee_name, sales_amount, order_count);
```

### 2. 分区策略
```sql
-- 按月分区 (MySQL 8.0)
CREATE TABLE employee_performance_partitioned (
    -- 字段定义同上
    ...
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
PARTITION BY RANGE (YEAR(data_date) * 100 + MONTH(data_date)) (
    PARTITION p202401 VALUES LESS THAN (202402),
    PARTITION p202402 VALUES LESS THAN (202403),
    PARTITION p202403 VALUES LESS THAN (202404),
    -- ... 更多分区
    PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- 自动分区管理存储过程
DELIMITER $$
CREATE PROCEDURE CreateMonthlyPartition(IN target_date DATE)
BEGIN
    DECLARE partition_name VARCHAR(20);
    DECLARE partition_value INT;

    SET partition_name = CONCAT('p', DATE_FORMAT(target_date, '%Y%m'));
    SET partition_value = YEAR(target_date) * 100 + MONTH(target_date) + 1;

    SET @sql = CONCAT('ALTER TABLE employee_performance_partitioned
                       ADD PARTITION (PARTITION ', partition_name,
                       ' VALUES LESS THAN (', partition_value, '))');

    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END$$
DELIMITER ;
```

### 3. 查询优化
```sql
-- 创建物化视图 (MySQL 8.0不支持，使用定时更新表替代)
CREATE TABLE mv_employee_performance_summary AS
SELECT
    employee_id,
    employee_name,
    dept_id,
    dept_name,
    DATE_FORMAT(data_date, '%Y-%m') as year_month,
    SUM(sales_amount) as total_sales,
    SUM(order_count) as total_orders,
    AVG(profit_rate) as avg_profit_rate,
    COUNT(*) as work_days
FROM employee_performance
WHERE status = 1
GROUP BY employee_id, employee_name, dept_id, dept_name, year_month;

-- 定时更新物化视图的存储过程
DELIMITER $$
CREATE PROCEDURE RefreshEmployeePerformanceSummary()
BEGIN
    TRUNCATE TABLE mv_employee_performance_summary;

    INSERT INTO mv_employee_performance_summary
    SELECT
        employee_id,
        employee_name,
        dept_id,
        dept_name,
        DATE_FORMAT(data_date, '%Y-%m') as year_month,
        SUM(sales_amount) as total_sales,
        SUM(order_count) as total_orders,
        AVG(profit_rate) as avg_profit_rate,
        COUNT(*) as work_days
    FROM employee_performance
    WHERE status = 1
    GROUP BY employee_id, employee_name, dept_id, dept_name, year_month;
END$$
DELIMITER ;
```

## 📈 数据库性能监控

### 1. 关键性能指标
```sql
-- 慢查询监控
SELECT
    query_time,
    lock_time,
    rows_sent,
    rows_examined,
    sql_text
FROM mysql.slow_log
WHERE start_time >= DATE_SUB(NOW(), INTERVAL 1 DAY)
ORDER BY query_time DESC;

-- 表空间使用情况
SELECT
    table_schema,
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size(MB)',
    table_rows
FROM information_schema.tables
WHERE table_schema = 'business_analysis'
ORDER BY (data_length + index_length) DESC;

-- 索引使用情况
SELECT
    object_schema,
    object_name,
    index_name,
    count_read,
    count_write,
    count_read / (count_read + count_write) * 100 as read_ratio
FROM performance_schema.table_io_waits_summary_by_index_usage
WHERE object_schema = 'business_analysis'
ORDER BY count_read DESC;
```

### 2. 数据库维护策略
- **定期备份**: 每日全量备份 + 实时binlog备份
- **数据清理**: 定期清理过期日志和临时数据
- **索引维护**: 定期分析和优化索引
- **统计信息更新**: 定期更新表统计信息
- **分区维护**: 自动创建新分区，删除过期分区
```
